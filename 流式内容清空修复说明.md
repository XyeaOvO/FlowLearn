# 流式内容清空修复说明

## 问题描述

在处理新单词时，旧的流式生成内容没有被清空，导致显示的内容混乱。具体表现为：

1. 开始处理新的单词时，旧的流式内容仍然显示在界面上
2. 新的流式内容会追加到旧内容后面
3. 用户看到的是一堆混合的内容，影响使用体验

## 问题原因

1. **前端状态不同步**：前端组件的 `streamContent` 状态与主进程的 `aiProcessingStatus.streamContent` 没有正确同步
2. **缺少清空机制**：在开始新的处理时，没有主动清空前端的流式内容
3. **状态重置不完整**：虽然主进程重置了状态，但前端没有及时接收到清空信号

## 修复方案

### 1. 前端组件修复 (AIProcessingWindow.tsx)

**修改内容**：
- 在窗口打开时清空流式内容
- 在检测到新的处理开始时清空流式内容
- 添加对 `status.startTime` 的依赖，确保状态变化时能正确响应

**具体修改**：
```typescript
useEffect(() => {
  if (!isOpen) return

  // 窗口打开时清空流式内容
  setStreamContent('')

  const checkStatus = async () => {
    try {
      const currentStatus = await getAIProcessingStatus()
      setStatus(currentStatus)
      
      // 如果开始新的处理，清空流式内容
      if (currentStatus.isProcessing && currentStatus.startTime > status.startTime) {
        setStreamContent('')
      }
    } catch (error) {
      console.error('Failed to get AI processing status:', error)
    }
  }

  // Check immediately
  checkStatus()

  // Check every 1 second for real-time updates
  const interval = setInterval(checkStatus, 1000)

  return () => clearInterval(interval)
}, [isOpen, status.startTime])
```

### 2. 主进程修复 (electron/main.ts)

**修改内容**：
- 在开始新处理时发送清空信号
- 在取消处理时发送清空信号
- 在处理完成时发送清空信号
- 在错误处理时发送清空信号

**具体修改**：

1. **开始处理时**：
```typescript
// 显示AI处理窗口
if (win) {
  win.webContents.send('show-ai-processing-window')
  // 发送清空流式内容的信号
  win.webContents.send('ai-stream-content', '')
}
```

2. **取消处理时**：
```typescript
function cancelAIProcessing() {
  // ... 现有代码 ...
  
  // 发送清空流式内容的信号
  if (win) {
    win.webContents.send('ai-stream-content', '')
  }
  
  updateAIStatus('cancelled', '用户取消了处理')
  return { success: true }
}
```

3. **处理完成时**：
```typescript
// 发送清空流式内容的信号
if (win) {
  win.webContents.send('ai-stream-content', '')
}
```

4. **错误处理时**：
```typescript
// 发送清空流式内容的信号
if (win) {
  win.webContents.send('ai-stream-content', '')
}
```

## 修复效果

修复后的效果：

1. **内容清空**：每次开始新的处理时，旧的流式内容会被清空
2. **状态同步**：前端和后端的状态保持同步
3. **用户体验**：用户看到的始终是当前处理的内容，不会混乱
4. **可靠性**：在各种情况下（开始、取消、完成、错误）都会正确清空内容

## 测试验证

可以通过以下方式验证修复效果：

1. **正常处理**：开始处理一批单词，然后立即开始处理另一批单词
2. **取消处理**：在处理过程中取消，然后开始新的处理
3. **错误处理**：模拟处理错误，然后开始新的处理
4. **连续处理**：快速连续处理多批单词

## 注意事项

- 所有功能保持不变，只是修复了内容清空的问题
- 清空操作是即时的，不会影响正在进行的处理
- 如果用户快速连续操作，可能会看到短暂的内容闪烁，这是正常现象
